name: ci
on:
  push:
  pull_request:

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y cmake g++ make clang clang-format clang-tidy ninja-build
      - name: Configure (Debug)
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Build (Debug)
        run: cmake --build build
      - name: Formatting check
        run: |
          find src tests \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' \) -print0 | xargs -0 clang-format --dry-run -Werror
      - name: Clang-tidy
        run: |
          find src tests -name '*.cpp' | xargs clang-tidy -p build

  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y cmake g++ make ninja-build
      - name: Configure (${{ matrix.build_type }})
        run: cmake -S . -B build-${{ matrix.build_type }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Build (${{ matrix.build_type }})
        run: cmake --build build-${{ matrix.build_type }}
      - name: Test (${{ matrix.build_type }})
        run: ctest --test-dir build-${{ matrix.build_type }} --output-on-failure
      - name: Integration (best-effort)
        run: bash scripts/integration_netns.sh || true
